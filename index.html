<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pixcom - Sorteio Pix</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon-192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .input-field {
      background: #1f2937;
      color: white;
      padding: 10px;
      width: 100%;
      margin-bottom: 10px;
      border: 1px solid #374151;
      border-radius: 4px;
    }
    .btn {
      background: #3b82f6;
      color: white;
      padding: 10px;
      width: 100%;
      border-radius: 4px;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">

<!-- VIEW PRINCIPAL -->
<section id="mainView">
  <div class="max-w-md mx-auto bg-gray-800 p-6 rounded-lg shadow mt-10 text-center">
    <h1 class="text-2xl font-bold text-pink-400 mb-4">Pixcom - Sorteio Pix Instagram!</h1>
    <p class="text-gray-300 mb-4">Inscreva-se para participar e ganhar um Pix!</p>
    <p class="mb-4 font-semibold">Status: <span class="text-yellow-400" id="statusText">Inscrições Abertas</span></p>
    <input type="text" id="instagramHandle" class="input-field" placeholder="@seuinstagram">
    <input type="text" id="pixKey" class="input-field" placeholder="Chave Pix">
    <button id="registerButton" class="btn" disabled>Quero Participar!</button>
    <h2 class="text-xl mt-6 mb-2 font-bold text-green-400">Participantes</h2>
    <ul id="participantsList" class="mb-2 hidden"></ul>
    <p id="loadingParticipants">Carregando participantes...</p>
    <p class="text-sm text-gray-400 mt-2">Seu ID: <span id="userIdDisplay"></span></p>
    <a href="#" id="adminLink" class="text-blue-400 text-sm mt-2 inline-block">Acesso Admin</a>
  </div>
</section>

<!-- VIEW LOGIN -->
<section id="loginView" class="hidden">
  <div class="max-w-md mx-auto bg-gray-800 p-6 rounded-lg shadow mt-10">
    <h2 class="text-xl font-bold text-yellow-400 text-center mb-4">Login do Admin</h2>
    <input type="email" id="adminEmail" class="input-field" placeholder="Email">
    <input type="password" id="adminPassword" class="input-field" placeholder="Senha">
    <button id="loginButton" class="btn">Entrar</button>
  </div>
</section>

<!-- VIEW ADMIN -->
<section id="adminPanel" class="hidden">
  <div class="max-w-xl mx-auto bg-gray-800 p-6 rounded-lg shadow mt-10">
    <h2 class="text-2xl font-bold text-yellow-300 mb-4 text-center">Painel de Administração</h2>
    <div class="flex justify-between items-center mb-4">
      <button id="toggleStatusBtn" class="btn w-1/2 mr-2">Recarregar Lista</button>
      <button id="logoutButton" class="bg-red-600 text-white px-4 py-2 rounded w-1/2 ml-2">Sair</button>
    </div>
    <h3 class="text-lg font-bold text-green-300 mt-6 mb-2">Todos os Participantes</h3>
    <table class="w-full text-sm table-auto text-left text-gray-200">
      <thead>
        <tr>
          <th>@ Instagram</th>
          <th>Chave Pix</th>
        </tr>
      </thead>
      <tbody id="adminParticipantsList"></tbody>
    </table>
  </div>
</section>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKlVI23YoxRb1fntQKy-ZfkzaDM-MWsSQ",
    authDomain: "doce-sabor-caseiro.firebaseapp.com",
    projectId: "doce-sabor-caseiro",
    storageBucket: "doce-sabor-caseiro.appspot.com",
    messagingSenderId: "414062499771",
    appId: "1:414062499771:web:1a811377bc6bbf145f969e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const mainView = document.getElementById("mainView");
  const loginView = document.getElementById("loginView");
  const adminPanel = document.getElementById("adminPanel");
  const registerButton = document.getElementById("registerButton");
  let currentUID = null;

  const showView = (view) => {
    [mainView, loginView, adminPanel].forEach(v => v.classList.add("hidden"));
    view.classList.remove("hidden");
  };

  registerButton.disabled = true;

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUID = user.uid;
      document.getElementById("userIdDisplay").textContent = currentUID;
      const isAdmin = user.providerData[0]?.providerId === "password";
      showView(isAdmin ? adminPanel : mainView);
      if (isAdmin) carregarParticipantesAdmin();
      registerButton.disabled = false;
    } else {
      try {
        await signInAnonymously(auth);
      } catch (e) {
        alert("Erro ao autenticar: " + e.message);
      }
    }
  });

  document.getElementById("adminLink").addEventListener("click", (e) => {
    e.preventDefault();
    showView(loginView);
  });

  document.getElementById("loginButton").onclick = async () => {
    const email = document.getElementById("adminEmail").value;
    const password = document.getElementById("adminPassword").value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      alert("Erro no login: " + e.message);
    }
  };

  document.getElementById("logoutButton").onclick = () => signOut(auth);

  registerButton.onclick = async () => {
    const instagram = document.getElementById("instagramHandle").value.trim();
    const chavePix = document.getElementById("pixKey").value.trim();
    if (!instagram || !chavePix) return alert("Preencha todos os campos!");
    if (!currentUID) return alert("Aguarde a autenticação...");
    try {
      await setDoc(doc(db, "participantes", currentUID), {
        instagram, chavePix, data: new Date().toISOString()
      });
      alert("Inscrição confirmada!");
    } catch (e) {
      alert("Erro ao salvar: " + e.message);
    }
  };

  const carregarParticipantes = () => {
    const lista = document.getElementById("participantsList");
    const carregando = document.getElementById("loadingParticipants");
    onSnapshot(collection(db, "participantes"), (snapshot) => {
      carregando.classList.add("hidden");
      lista.innerHTML = "";
      snapshot.forEach(doc => {
        const li = document.createElement("li");
        li.textContent = doc.data().instagram;
        lista.appendChild(li);
      });
      lista.classList.remove("hidden");
    });
  };

  const carregarParticipantesAdmin = async () => {
    const snapshot = await getDocs(collection(db, "participantes"));
    const tbody = document.getElementById("adminParticipantsList");
    tbody.innerHTML = "";
    snapshot.forEach(doc => {
      const d = doc.data();
      tbody.innerHTML += `<tr><td>${d.instagram}</td><td>${d.chavePix}</td></tr>`;
    });
  };

  document.getElementById("toggleStatusBtn").onclick = carregarParticipantesAdmin;
  carregarParticipantes();
</script>

</body>
</html>