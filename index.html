<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plane.Money</title>
  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { doc, getDoc, updateDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    let userUID = null;
    let modoAtual = 'real';
    let saldoReal = 0;
    let saldoDemo = 0;
    let apostaAtiva = false;
    let autoCashOut = null;

    function atualizarUI() {
      document.getElementById("saldo").innerText = (modoAtual === 'real' ? saldoReal : saldoDemo).toFixed(2);
      document.getElementById("btnReal").className = modoAtual === 'real' ? "ativo" : "inativo";
      document.getElementById("btnDemo").className = modoAtual === 'demo' ? "ativo" : "inativo";
    }

    window.mudarModo = function(novoModo) {
      modoAtual = novoModo;
      atualizarUI();
    };

    window.logout = () => signOut(auth).then(() => location.href = "auth.html");

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "auth.html";
      userUID = user.uid;

      const ref = doc(db, "usuarios", userUID);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        saldoReal = data.saldoReal || 0;
        saldoDemo = data.saldoDemo || 0;
        atualizarUI();
      } else {
        await setDoc(ref, { saldoReal: 100, saldoDemo: 100 });
        saldoReal = 100;
        saldoDemo = 100;
        atualizarUI();
      }

      iniciarVoo();
    });

    window.getSaldoAtual = () => (modoAtual === 'real' ? saldoReal : saldoDemo);
    window.setSaldoAtual = async (novoSaldo) => {
      const ref = doc(db, "usuarios", userUID);
      if (modoAtual === 'real') {
        saldoReal = novoSaldo;
        await updateDoc(ref, { saldoReal });
      } else {
        saldoDemo = novoSaldo;
        await updateDoc(ref, { saldoDemo });
      }
      atualizarUI();
    };

    window.apostar = function() {
      const valor = parseFloat(document.getElementById("aposta1").value);
      autoCashOut = parseFloat(document.getElementById("auto1").value);

      if (isNaN(valor) || valor <= 0) return alert("Valor inválido.");
      const saldoAtual = getSaldoAtual();
      if (valor > saldoAtual) return alert("Saldo insuficiente.");

      setSaldoAtual(saldoAtual - valor);
      apostaAtiva = true;
      alert("Aposta realizada!");
    };

    window.encerrarAposta = function(mult) {
      if (!apostaAtiva) return;
      const valor = parseFloat(document.getElementById("aposta1").value);
      const ganho = valor * mult;
      setSaldoAtual(getSaldoAtual() + ganho);
      apostaAtiva = false;
      alert(`Você ganhou R$ ${ganho.toFixed(2)}!`);
    }

    function iniciarVoo() {
      const aviao = document.getElementById("aviao");
      const fundo = document.getElementById("fundoAnimado");
      const multEl = document.getElementById("multiplicador");

      let x = 0;
      let mult = 1.00;
      const stopMult = apostaAtiva ? (Math.random() * 9 + 1) : (Math.random() * 110 + 10);
      const velocidade = 2;
      const largura = window.innerWidth;

      const animar = () => {
        x += velocidade;
        mult += 0.05;
        aviao.style.left = x + "px";
        multEl.innerText = mult.toFixed(2) + "x";
        fundo.style.backgroundPositionX = (-x) + "px";

        if (autoCashOut && apostaAtiva && mult >= autoCashOut) {
          encerrarAposta(mult);
        }

        if (mult >= stopMult || x >= largura + 100) {
          aviao.style.display = "none";
          apostaAtiva = false;
          clearInterval(timer);
          setTimeout(() => {
            aviao.style.left = "0px";
            aviao.style.display = "block";
            iniciarVoo();
          }, 3000);
        }
      }
      const timer = setInterval(animar, 50);
    }
  </script>
  <style>
    body { margin: 0; background: #121212; color: white; font-family: sans-serif; overflow-x: hidden; }
    #gameArea { position: relative; height: 300px; background: #1e1e1e; overflow: hidden; }
    #fundoAnimado { position: absolute; width: 1000%; height: 100%; background-image: linear-gradient(to right, #1e1e1e 50%, #2a2a2a 50%); background-size: 200px 100%; }
    #aviao { position: absolute; top: 200px; left: 0; width: 100px; height: auto; z-index: 5; }
    .multiplier { position: absolute; top: 10px; left: 10px; font-size: 2.5em; color: red; }
    .saldo, .modo, .acoes, .apostas-container { margin: 10px; text-align: center; }
    .input-aposta, .botao-verde { width: 90%; padding: 10px; margin: 5px auto; display: block; font-size: 1.1em; border-radius: 5px; border: none; }
    .botao-verde { background: #00cc00; color: white; cursor: pointer; }
    .modo button { margin: 0 5px; padding: 5px 10px; border-radius: 5px; }
    .ativo { background: green; color: white; }
    .inativo { background: gray; color: white; }
  </style>
</head>
<body>
  <div id="gameArea">
    <div id="fundoAnimado"></div>
    <img src="IMG_5585.jpeg" id="aviao" />
    <div class="multiplier" id="multiplicador">1.00x</div>
  </div>

  <div class="saldo">
    Saldo: R$ <span id="saldo">0.00</span>
  </div>
  <div class="modo">
    <button id="btnReal" class="ativo" onclick="mudarModo('real')">Modo Real</button>
    <button id="btnDemo" class="inativo" onclick="mudarModo('demo')">Modo Demo</button>
  </div>
  <div class="acoes">
    <button onclick="depositar()">Depositar</button>
    <button onclick="sacar()">Sacar</button>
    <button onclick="window.location.href='wallet.html'">Carteira</button>
    <button onclick="logout()">Sair</button>
  </div>

  <div class="apostas-container">
    <input class="input-aposta" id="aposta1" type="number" placeholder="Valor da aposta">
    <input class="input-aposta" id="auto1" type="number" placeholder="Auto cash-out (ex: 2.0)">
    <button class="botao-verde" onclick="apostar()">Apostar</button>
    <button class="botao-verde" onclick="encerrarAposta(parseFloat(document.getElementById('multiplicador').innerText))">Encerrar Aposta</button>
  </div>
</body>
</html>